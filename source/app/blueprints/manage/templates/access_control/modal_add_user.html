<div class="modal-xl modal-dialog" role="document">
    <div class="modal-content" id="modal_access_control_content">
        <div class="modal-header">
            <div class="row w-100 d-flex justify-content-center">
                <h4 class="modal-title ml-4 mt-3">{% if not user.user_id %}Add User{% else %} Edit user {% endif %}</h4>

                <div class="col">
                    {% if user.user_id %}
                    <ul class="nav nav-pills nav-default justify-content-center" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active show" data-toggle="pill" href="#user_details_tab" role="tab" aria-controls="user_details_tab" aria-selected="false">Info</a>
                        </li>

                        <li class="nav-item submenu">
                            <a class="nav-link"  data-toggle="pill" href="#user_permissions_tab" role="tab" aria-controls="user_permissions_tab" aria-selected="false">Permissions</a>
                        </li>

                        <li class="nav-item submenu">
                            <a class="nav-link"  data-toggle="pill" href="#user_groups_tab" role="tab" aria-controls="user_groups_tab" aria-selected="false">Groups</a>
                        </li>

                        <li class="nav-item submenu">
                            <a class="nav-link"  data-toggle="pill" href="#user_orgs_tab" role="tab" aria-controls="user_orgs_tab" aria-selected="false">Organisations</a>
                        </li>

                    </ul>
                    {% endif %}
                </div>

                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
            </div>
        </div>
        <div class="modal-body">
            <div role="tabpanel">
                <div class="tab-content">
                    <div class="tab-pane active" id="user_details_tab">
                        <div class="container col-md-12">
                            <form method="post" action="" id="form_new_user">
                                <div class="col-md-12 col-lg-12 col-sm-12">
                                    {{ form.hidden_tag() }}
                                    {% if not user.user_id %}
                                        <p class="ml-3"><i class="fa-solid fa-circle-info mr-2"></i>Permissions, groups and organisations memberships can be set once the user is created.</p>
                                    {% endif %}
                                    <div class="form-group">
                                        <label for="asset_type" class="mr-4">Full name
                                        </label>
                                        {{ form.user_name(class='form-control',  autocomplete="off") }}
                                    </div>
                                    <div class="form-group mt-3">
                                        <label for="asset_description" class="placeholder">Login</label>
                                        {{ form.user_login(class='form-control',  autocomplete="off") }}
                                    </div>
                                    <div class="form-group mt-3">
                                        <label for="asset_description" class="placeholder">Email</label>
                                        {{ form.user_email(class='form-control',  autocomplete="off") }}
                                    </div>
                                    <div class="form-group mt-3">
                                        <label for="asset_description" class="placeholder">Password</label>
                                        <ul >
                                            <li><small>Must contain at least {{ server_settings.password_policy_min_length }} chars</small></li>
                                            {% if server_settings.password_policy_upper_case %}
                                                <li class="text-sm"><small>Must contain at least an upper case</small></li>
                                            {% endif %}
                                            {% if server_settings.password_policy_lower_case %}
                                                <li class="text-sm"><small>Must contain at least a lower case</small></li>
                                            {% endif %}
                                            {% if server_settings.password_policy_digit %}
                                                <li class="text-sm"><small>Must contain at least a digit</small></li>
                                            {% endif %}
                                            {% if server_settings.password_policy_special_chars %}
                                                <li class="text-sm"><small>Must contain at least one of : {{ server_settings.password_policy_special_chars }}</small></li>
                                            {% endif %}
                                        </ul>
                                        <div class="input-group mb-3">
                                            {{ form.user_password(class='form-control', autocomplete="off") }}
                                            <div class="input-group-append">
                                                <span class="input-group-text">
                                                    <div class="user_show_password" id="toggle_user_password"><i class="fa-solid fa-eye"></i></div>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-check mt-3">
                                        <label class="form-check-label">
                                            {{ form.user_isadmin(class="form-check-input", type="checkbox") }}
                                            <span class="form-check-sign">Is admin</span>
                                        </label>
                                    </div>
                                </div>
                                {% if user.id %}
                                    <button type="button" class="btn btn-danger mt-5"
                                    onclick="delete_user('{{ user.user_id }}');">Delete</button>
                                    {% if user.active %}
                                    <button type="button" class="btn btn-outline-danger mt-5"
                                    onclick="deactivate_user('{{ user.user_id }}');">Deactivate</button>
                                    {% else %}
                                    <button type="button" class="btn btn-outline-success mt-5"
                                    onclick="activate_user('{{ user.user_id }}');">Activate</button>
                                    {% endif %}
                                    <button type="button" class="btn btn-outline-success ml-4 mt-5 float-right"
                                    id="submit_new_user">Update</button>

                                {% else %}

                                    <button type="button" class="btn btn-outline-success ml-4 mt-5 float-right"
                                    id="submit_new_user">Save</button>

                                {% endif %}
                            </form>
            </div>
                    </div>
                    <div class="tab-pane" id="user_permissions_tab">
                        <div class="container col-md-12">
                            <p class="mb-4"><i class="fa-solid fa-circle-info mr-2"></i>Permissions are inherited from the groups the user belongs to. The table shows the effective permissions the user has on the platform.</p>
                            <table class="table table-striped" id="user_permissions_table">
                                <thead>
                                    <tr>
                                        <th>Permission</th>
                                        <th>Value</th>
                                        <th>Inherited from groups</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for perm in user.user_permissions %}
                                    <tr>
                                        <td>{{ user.user_permissions[perm].name }}</td>
                                        <td>0x{{ perm | int(perm,16) }}</td>
                                        <td>{% for group in user.user_permissions[perm].inherited_from %}<span class="badge ml-2 badge-light">{{ group }}</span>{% endfor %}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane" id="user_groups_tab">
                        <div class="container col-md-12">
                            <p>Groups the user is member of.</p>
                            <table class="table table-striped" id="user_groups_table">
                                <thead>
                                    <tr>
                                        <th>Group name</th>
                                        <th>Group ID</th>
                                        <th>Group UUID</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for group in user.user_groups %}
                                    <tr>
                                        <td>{{ group.group_name }}</td>
                                        <td>{{ group.group_id }}</td>
                                        <td>{{ group.group_uuid }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane" id="user_orgs_tab">
                        <div class="container col-md-12">
                            <p>Organisations the user is member of.</p>
                            <table class="table table-striped" id="user_orgs_table">
                                <thead>
                                    <tr>
                                        <th>Organisation name</th>
                                        <th>Organisation ID</th>
                                        <th>Organisation UUID</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for org in user.user_organisations %}
                                    <tr>
                                        <td>{{ org.org_name }}</td>
                                        <td>{{ org.org_id }}</td>
                                        <td>{{ org.org_uuid }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            $('#toggle_user_password').on('click', function (e) {
                const type = $('#user_password').attr('type') === 'password' ? 'text' : 'password';
                $('#user_password').attr('type', type);
                $('#toggle_user_password > i').attr('class', type === 'password' ? 'fa-solid fa-eye' : 'fa-solid fa-eye-slash');
            });

            $('#user_permissions_table').dataTable({
                "order": [[ 1, "asc" ]]});
            $('#user_groups_table').dataTable({
                "order": [[ 1, "asc" ]]});
            $('#user_orgs_table').dataTable({
                "order": [[ 1, "asc" ]],
                "columns": [{
                    "title": "org_name",
                    "render": function ( data, type, row, meta ) {
                        if (type === 'display' ) {
                            return `<i class="fa-solid fa-circle-minus mr-2 text-warning" style="cursor:pointer;" title="Remove from org" href="javascript:void(0)" onclick="remove_member_from_org_wrap('${row[1]}','{{ user.user_id }}')"></i>${data}`;
                        }
                        return data;
                    }},
                    {"title": "org_id"},
                    {"title": "org_uuid"}
                    ]
            });
        </script>
    </div><!-- /.modal-content -->
</div><!-- /.modal-dialog -->